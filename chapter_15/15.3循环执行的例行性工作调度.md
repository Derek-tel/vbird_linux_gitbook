# 15.3 循环执行的例行性工作调度

相对于 at 是仅执行一次的工作，循环执行的例行性工作调度则是由 cron （crond） 这个系统服务来控制的。刚刚谈过 Linux 系统上面原本就有非常多的例行性工作，因此这个系统服务是默认启动的。另外， 由于使用者自己也可以进行例行性工作调度，所以啰， Linux 也提供使用者控制例行性工作调度的指令 （crontab）。 下面我们分别来聊一聊啰！

## 15.3.1 使用者的设置

使用者想要创建循环型工作调度时，使用的是 crontab 这个指令啦～不过，为了安全性的问题， 与 at 同样的，我们可以限制使用 crontab 的使用者帐号喔！使用的限制数据有：

-   /etc/cron.allow： 将可以使用 crontab 的帐号写入其中，若不在这个文件内的使用者则不可使用 crontab；

-   /etc/cron.deny： 将不可以使用 crontab 的帐号写入其中，若未记录到这个文件当中的使用者，就可以使用 crontab 。

与 at 很像吧！同样的，以优先顺序来说， /etc/cron.allow 比 /etc/cron.deny 要优先， 而判断上面，这两个文件只选择一个来限制而已，因此，建议你只要保留一个即可， 免得影响自己在设置上面的判断！一般来说，系统默认是保留 /etc/cron.deny ， 你可以将不想让他执行 crontab 的那个使用者写入 /etc/cron.deny 当中，一个帐号一行！

当使用者使用 crontab 这个指令来创建工作调度之后，该项工作就会被纪录到 /var/spool/cron/ 里面去了，而且是以帐号来作为判别的喔！举例来说， dmtsai 使用 crontab 后， 他的工作会被纪录到 /var/spool/cron/dmtsai 里头去！但请注意，不要使用 vi 直接编辑该文件， 因为可能由于输入语法错误，会导致无法执行 cron 喔！另外， cron 执行的每一项工作都会被纪录到 /var/log/cron 这个登录文件中，所以啰，如果你的 Linux 不知道有否被植入木马时，也可以搜寻一下 /var/log/cron 这个登录文件呢！

好了，那么我们就来聊一聊 crontab 的语法吧！

```shell
[root@study ~]# crontab [-u username] [-l&#124;-e&#124;-r]
选项与参数：
-u  ：只有 root 才能进行这个任务，亦即帮其他使用者创建/移除 crontab 工作调度；
-e  ：编辑 crontab 的工作内容
-l  ：查阅 crontab 的工作内容
-r  ：移除所有的 crontab 的工作内容，若仅要移除一项，请用 -e 去编辑。

范例一：用 dmtsai 的身份在每天的 12:00 发信给自己
[dmtsai@study ~]$ crontab -e
# 此时会进入 vi 的编辑画面让您编辑工作！注意到，每项工作都是一行。
0   12  *  *  * mail -s "at 12:00" dmtsai < /home/dmtsai/.bashrc
#分 时 日 月 周 &#124;<==============指令串========================>&#124;
```

默认情况下，任何使用者只要不被列入 /etc/cron.deny 当中，那么他就可以直接下达“ crontab -e ”去编辑自己的例行性命令了！整个过程就如同上面提到的，会进入 vi 的编辑画面， 然后以一个工作一行来编辑，编辑完毕之后输入“ :wq ”储存后离开 vi 就可以了！ 而每项工作 （每行） 的格式都是具有六个字段，这六个字段的意义为：

| 代表意义 | 分钟 | 小时 | 日期 | 月份 | 周  | 指令       |
|----------|------|------|------|------|-----|------------|
| 数字范围 | 0-59 | 0-23 | 1-31 | 1-12 | 0-7 | 呀就指令啊 |

比较有趣的是那个“周”喔！周的数字为 0 或 7 时，都代表“星期天”的意思！另外，还有一些辅助的字符，大概有下面这些：

| 特殊字符   | 代表意义   |
|------------|-----------------|
| \*（星号） | 代表任何时刻都接受的意思！举例来说，范例一内那个日、月、周都是 \* ， 就代表着“不论何月、何日的礼拜几的 12:00 都执行后续指令”的意思！                                   |
| ,（逗号）  | 代表分隔时段的意思。举例来说，如果要下达的工作是 3:00 与 6:00 时，就会是： `> 0 3,6 * * * command` 时间参数还是有五栏，不过第二栏是 3,6 ，代表 3 与 6 都适用！         |
| -（减号）  | 代表一段时间范围内，举例来说， 8 点到 12 点之间的每小时的 20 分都进行一项工作： `> 20 8-12 * * * command` 仔细看到第二栏变成 8-12 喔！代表 8,9,10,11,12 都适用的意思！ |
| /n（斜线） | 那个 n 代表数字，亦即是“每隔 n 单位间隔”的意思，例如每五分钟进行一次，则： `> */5 * * * * command` 很简单吧！用 \* 与 /5 来搭配，也可以写成 0-59/5 ，相同意思！        |

我们就来搭配几个例子练习看看吧！下面的案例请实际用 dmtsai 这个身份作看看喔！后续的动作才能够搭配起来！

例题：假若你的女朋友生日是 5 月 2 日，你想要在 5 月 1 日的 23:59 发一封信给他，这封信的内容已经写在 /home/dmtsai/lover.txt 内了，该如何进行？答：直接下达 crontab -e 之后，编辑成为：

```shell
> 59 23 1 5 * mail kiki < /home/dmtsai/lover.txt
```

那样的话，每年 kiki 都会收到你的这封信喔！（当然啰，信的内容就要每年变一变啦！）

例题：假如每五分钟需要执行 /home/dmtsai/test.sh 一次，又该如何？答：同样使用 crontab -e 进入编辑：

```shell
> */5 * * * * /home/dmtsai/test.sh
```

那个 crontab 每个人都只有一个文件存在，就是在 /var/spool/cron 里面啊！ 还有建议您：“指令下达时，最好使用绝对路径，这样比较不会找不到可执行文件喔！”

例题：假如你每星期六都与朋友有约，那么想要每个星期五下午 4:30 告诉你朋友星期六的约会不要忘记，则：答：还是使用 crontab -e 啊！

```shell
> 30 16 * * 5 mail friend@his.server.name < /home/dmtsai/friend.txt
```

真的是很简单吧！呵呵！那么，该如何查询使用者目前的 crontab 内容呢？我们可以这样来看看：

```shell
[dmtsai@study ~]$ crontab -l
0 12 * * * mail -s "at 12:00" dmtsai < /home/dmtsai/.bashrc
59 23 1 5 * mail kiki < /home/dmtsai/lover.txt
*/5 * * * * /home/dmtsai/test.sh
30 16 * * 5 mail friend@his.server.name < /home/dmtsai/friend.txt

# 注意，若仅想要移除一项工作而已的话，必须要用 crontab -e 去编辑～
# 如果想要全部的工作都移除，才使用 crontab -r 喔！
[dmtsai@study ~]$ crontab -r
[dmtsai@study ~]$ crontab -l
no crontab for dmtsai
```

看到了吗？ crontab “整个内容都不见了！”所以请注意：“如果只是要删除某个 crontab 的工作项目，那么请使用 crontab -e 来重新编辑即可！”如果使用 -r 的参数，是会将所有的 crontab 数据内容都删掉的！千万注意了！

## 15.3.2 系统的配置文件： /etc/crontab, /etc/cron.d/\*

这个“ crontab -e ”是针对使用者的 cron 来设计的，如果是“系统的例行性任务”时， 该怎么办呢？是否还是需要以 crontab -e 来管理你的例行性工作调度呢？当然不需要，你只要编辑 /etc/crontab 这个文件就可以啦！有一点需要特别注意喔！那就是 crontab -e 这个 crontab 其实是 /usr/bin/crontab 这个可执行文件，但是 /etc/crontab 可是一个“纯文本文件”喔！你可以 root 的身份编辑一下这个文件哩！

基本上， cron 这个服务的最低侦测限制是“分钟”，所以“ cron 会每分钟去读取一次 /etc/crontab 与 /var/spool/cron 里面的数据内容 ”，因此，只要你编辑完 /etc/crontab 这个文件，并且将他储存之后，那么 cron 的设置就自动的会来执行了！



**Tips** 在 Linux 下面的 crontab 会自动的帮我们每分钟重新读取一次 /etc/crontab 的例行工作事项，但是某些原因或者是其他的 Unix 系统中，由于 crontab 是读到内存当中的，所以在你修改完 /etc/crontab 之后，可能并不会马上执行， 这个时候请重新启动 crond 这个服务吧！“systemctl restart crond”

废话少说，我们就来看一下这个 /etc/crontab 的内容吧！

```shell
[root@study ~]# cat /etc/crontab
SHELL=/bin/bash                     <==使用哪种 shell 接口
PATH=/sbin:/bin:/usr/sbin:/usr/bin  <==可执行文件搜寻路径
MAILTO=root                         <==若有额外STDOUT，以 email将数据送给谁

# Example of job definition:
# .---------------- minute （0 - 59）
# &#124;  .------------- hour （0 - 23）
# &#124;  &#124;  .---------- day of month （1 - 31）
# &#124;  &#124;  &#124;  .------- month （1 - 12） OR jan,feb,mar,apr ...
# &#124;  &#124;  &#124;  &#124;  .---- day of week （0 - 6） （Sunday=0 or 7） OR sun,mon,tue,wed,thu,fri,sat
# &#124;  &#124;  &#124;  &#124;  &#124;
# *  *  *  *  * user-name  command to be executed
```

看到这个文件的内容你大概就了解了吧！呵呵，没错！这个文件与将刚刚我们下达 crontab -e 的内容几乎完全一模一样！只是有几个地方不太相同：

-   MAILTO=root：

这个项目是说，当 /etc/crontab 这个文件中的例行性工作的指令发生错误时，或者是该工作的执行结果有 STDOUT/STDERR 时，会将错误讯息或者是屏幕显示的讯息传给谁？默认当然是由系统直接寄发一封 mail 给 root 啦！不过， 由于 root 并无法在用户端中以 POP3 之类的软件收信，因此，鸟哥通常都将这个 e-mail 改成自己的帐号，好让我随时了解系统的状况！例如： MAILTO=dmtsai@my.host.name

-   PATH=....：

还记得我们在[第十章的 BASH] 当中一直提到的可执行文件路径问题吧！ 没错啦！这里就是输入可执行文件的搜寻路径！使用默认的路径设置就已经很足够了！

-   “分 时 日 月 周 身份 指令”七个字段的设置

这个 /etc/crontab 里面可以设置的基本语法与 crontab -e 不太相同喔！前面同样是分、时、日、月、周五个字段， 但是在五个字段后面接的并不是指令，而是一个新的字段，那就是“执行后面那串指令的身份”为何！这与使用者的 crontab -e 不相同。由于使用者自己的 crontab 并不需要指定身份，但 /etc/crontab 里面当然要指定身份啦！以上表的内容来说，系统默认的例行性工作是以 root 的身份来进行的。

-   crond 服务读取配置文件的位置

一般来说，crond 默认有三个地方会有执行脚本配置文件，他们分别是：

-   /etc/crontab
-   /etc/cron.d/\*
-   /var/spool/cron/\*

这三个地方中，跟系统的运行比较有关系的两个配置文件是放在 /etc/crontab 文件内以及 /etc/cron.d/\* 目录内的文件， 另外一个是跟用户自己的工作比较有关的配置文件，就是放在 /var/spool/cron/ 里面的文件群。 现在我们已经知道了 /var/spool/cron 以及 /etc/crontab 的内容，那现在来瞧瞧 /etc/cron.d 里面的东西吧！

```shell
[root@study ~]# ls -l /etc/cron.d
-rw-r--r--. 1 root root 128 Jul 30  2014 0hourly
-rw-r--r--. 1 root root 108 Mar  6 10:12 raid-check
-rw-------. 1 root root 235 Mar  6 13:45 sysstat
-rw-r--r--. 1 root root 187 Jan 28  2014 unbound-anchor
# 其实说真的，除了 /etc/crontab 之外，crond 的配置文件还不少耶！上面就有四个设置！
# 先让我们来瞧瞧 0hourly 这个配置文件的内容吧！

[root@study ~]# cat /etc/cron.d/0hourly
# Run the hourly jobs
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
01 * * * * root run-parts /etc/cron.hourly
# 瞧一瞧，内容跟 /etc/crontab 几乎一模一样！但实际上是有设置值喔！就是最后一行！
```

如果你想要自己开发新的软件，该软件要拥有自己的 crontab 定时指令时，就可以将“分、时、日、月、周、身份、指令”的配置文件放置到 /etc/cron.d/ 目录下！ 在此目录下的文件是“crontab 的配置文件脚本”。



**Tips** 以鸟哥来说，现在鸟哥有在开发一些虚拟化教室的软件，该软件需要定时清除一些垃圾防火墙规则， 那鸟哥就是将要执行的时间与指令设计好，然后直接将设置写入到 /etc/cron.d/newfile 即可！未来如果这个软件要升级， 直接将该文件覆盖成新文件即可！比起手动去分析 /etc/crontab 要单纯的多！

另外，请注意一下上面表格中提到的最后一行，每个整点的一分会执行“ run-parts /etc/cron.hourly ”这个指令～咦！那什么是 run-parts 呢？ 如果你有去分析一下这个可执行文件，会发现他就是 shell script，run-parts 脚本会在大约 5 分钟内随机选一个时间来执行 /etc/cron.hourly 目录内的所有可执行文件！因此，放在 /etc/cron.hourly/ 的文件，必须是能被直接执行的指令脚本， 而不是分、时、日、月、周的设置值喔！注意注意！

也就是说，除了自己指定分、时、日、月、周加上指令路径的 crond 配置文件之外，你也可以直接将指令放置到（或链接到）/etc/cron.hourly/ 目录下， 则该指令就会被 crond 在每小时的 1 分开始后的 5 分钟内，随机取一个时间点来执行啰！你无须手动去指定分、时、日、月、周就是了。

但是眼尖的朋友可能还会发现，除了可以直接将指令放到 /etc/cron.hourly/ 让系统每小时定时执行之外，在 /etc/ 下面其实还有 /etc/cron.daily/, /etc/cron.weekly/, /etc/cron.monthly/，那三个目录是代表每日、每周、每月各执行一次的意思吗？嘿嘿！ 厉害喔！没错～是这样～不过，跟 /etc/cron.hourly/ 不太一样的是，那三个目录是由 anacron 所执行的，而 anacron 的执行方式则是放在 /etc/cron.hourly/0anacron 里面耶～跟前几代 anacron 是单独的 service 不太一样喔！这部份留待下个小节再来讨论。

最后，让我们总结一下吧：

-   个人化的行为使用“ crontab -e ”：如果你是依据个人需求来创建的例行工作调度，建议直接使用 crontab -e 来创建你的工作调度较佳！ 这样也能保障你的指令行为不会被大家看到 （/etc/crontab 是大家都能读取的权限喔！）；
-   系统维护管理使用“ vim /etc/crontab ”：如果你这个例行工作调度是系统的重要工作，为了让自己管理方便，同时容易追踪，建议直接写入 /etc/crontab 较佳！
-   自己开发软件使用“ vim /etc/cron.d/newfile ”：如果你是想要自己开发软件，那当然最好就是使用全新的配置文件，并且放置于 /etc/cron.d/ 目录内即可。
-   固定每小时、每日、每周、每天执行的特别工作：如果与系统维护有关，还是建议放置到 /etc/crontab 中来集中管理较好。 如果想要偷懒，或者是一定要再某个周期内进行的任务，也可以放置到上面谈到的几个目录中，直接写入指令即可！

## 15.3.3 一些注意事项

有的时候，我们以系统的 cron 来进行例行性工作的创建时，要注意一些使用方面的特性。 举例来说，如果我们有四个工作都是五分钟要进行一次的，那么是否这四个动作全部都在同一个时间点进行？ 如果同时进行，该四个动作又很耗系统资源，如此一来，每五分钟的某个时刻不是会让系统忙得要死？ 呵呵！此时好好的分配一些执行时间就 OK 啦！所以，注意一下：

-   资源分配不均的问题

当大量使用 crontab 的时候，总是会有问题发生的，最严重的问题就是“系统资源分配不均”的问题， 以鸟哥的系统为例，我有侦测主机流量的信息，包括：

-   流量
-   区域内其他 PC 的流量侦测
-   CPU 使用率
-   RAM 使用率
-   线上人数实时侦测

如果每个流程都在同一个时间启动的话，那么在某个时段时，我的系统会变的相当的繁忙，所以，这个时候就必须要分别设置啦！我可以这样做：

```shell
[root@study ~]# vim /etc/crontab
1,6,11,16,21,26,31,36,41,46,51,56 * * * * root  CMD1
2,7,12,17,22,27,32,37,42,47,52,57 * * * * root  CMD2
3,8,13,18,23,28,33,38,43,48,53,58 * * * * root  CMD3
4,9,14,19,24,29,34,39,44,49,54,59 * * * * root  CMD4
```

看到了没？那个“ , ”分隔的时候，请注意，不要有空白字符！（连续的意思）如此一来， 则可以将每五分钟工作的流程分别在不同的时刻来工作！则可以让系统的执行较为顺畅呦！

-   取消不要的输出项目

另外一个困扰发生在“ 当有执行成果或者是执行的项目中有输出的数据时，该数据将会 mail 给 MAILTO 设置的帐号 ”，好啦，那么当有一个调度一直出错（例如 DNS 的侦测系统当中，若 DNS 上层主机挂掉，那么你就会一直收到错误讯息！）怎么办？呵呵！还记得[第十章谈到的数据流重导向]吧？ 直接以“数据流重导向”将输出的结果输出到 /dev/null 这个垃圾桶当中就好了！

-   安全的检验

很多时候被植入木马都是以例行命令的方式植入的，所以可以借由检查 /var/log/cron 的内容来视察是否有“非您设置的 cron 被执行了？”这个时候就需要小心一点啰！

-   周与日月不可同时并存

另一个需要注意的地方在于：“你可以分别以周或者是日月为单位作为循环，但你不可使用「几月几号且为星期几」的模式工作”。 这个意思是说，你不可以这样编写一个工作调度：

```shell
30 12 11 9 5 root echo "just test"   <==这是错误的写法
```

本来你以为九月十一号且为星期五才会进行这项工作，无奈的是，系统可能会判定每个星期五作一次，或每年的 9 月 11 号分别进行，如此一来与你当初的规划就不一样了～所以啰，得要注意这个地方！



**Tips** 根据某些人的说法，这个月日、周不可并存的问题已经在新版中被克服了～不过，鸟哥并没有实际去验证他！目前也不打算验证他！ 因为，周就是周，月日就月日，单一执行点就单一执行点，无须使用 crontab 去设置固定的日期啊！您说是吧？